<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ç•°ä¸–ç•Œãƒ‹ãƒ£ãƒ³é‚„ ã€œé­”ç‹ã‚’å€’ã—ãŸå‹‡è€…ã®å®¶é›»ä¿®ç†è¨˜ã€œ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
/* --- åŸºæœ¬è¨­å®š --- */
:root {
  --pce-blue-top: #000088;
  --pce-blue-bottom: #0000cc;
  --text-color: #ffffff;
  --border-color: #eeeeee;
  --card-bg: #f8f8f8;
  --card-shadow: rgba(0,0,0,0.5);
}

* { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; }

body {
  font-family: 'DotGothic16', monospace;
  background-color: #000;
  color: var(--text-color);
  width: 100%; height: 100dvh; /* dvhã§ãƒ¢ãƒã‚¤ãƒ«ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼è€ƒæ…® */
  overflow: hidden;
  display: flex; justify-content: center; align-items: center;
  touch-action: none; /* å…¨ä½“çš„ãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
}

.scanlines {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
  background-size: 100% 4px; pointer-events: none; z-index: 100;
}

.game-container {
  width: 100%; height: 100%; max-width: 1024px;
  background-color: #000; position: relative;
  display: flex; flex-direction: column;
}

/* --- ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¨ãƒªã‚¢ --- */
.visual-area {
  flex: 1; position: relative; overflow: hidden; background-color: #000; min-height: 40%;
}
.bg-image { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 0; }

.actors-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 2; pointer-events: none; }
.actor { position: absolute; bottom: 5%; transition: all 0.3s ease; filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.5)); }
.hero { left: 5%; height: 35%; width: auto; image-rendering: pixelated; }
.npc { right: 5%; height: 45%; width: auto; }
.actor.item { left: 50%; transform: translateX(-50%); bottom: 10%; height: 40%; width: auto; mix-blend-mode: multiply; }

/* --- çŒ«éƒ¨å±‹ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ï¼‰ç”¨ --- */
.cat-room-layer {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  z-index: 1; pointer-events: none;
}
.room-cat {
  position: absolute;
  width: 60px; height: auto;
  animation: floatCat 3s ease-in-out infinite;
  filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
}
@keyframes floatCat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

.title-screen {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  z-index: 50;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  background: rgba(0,0,0,0.4);
}
.title-logo {
  font-size: 2rem; color: #ffff00; text-shadow: 4px 4px 0 #000; margin-bottom: 20px; text-align: center;
}
.start-btn {
  background: #ff4444; border: 4px solid #fff; color: #fff;
  font-family: 'DotGothic16', monospace; font-size: 1.5rem;
  padding: 15px 40px; border-radius: 30px; cursor: pointer;
  animation: pulse 1s infinite;
}

/* --- UIã‚¨ãƒªã‚¢ --- */
.ui-area {
  height: 45%; background-color: #000; padding: 2%;
  position: relative; z-index: 10; display: flex; flex-direction: column;
  /* iOS Safe Area å¯¾å¿œ */
  padding-bottom: max(2%, env(safe-area-inset-bottom));
}
.status-bar {
  position: absolute; top: 15px; right: 15px;
  background: rgba(0,0,0,0.8); padding: 8px 15px; border-radius: 25px;
  z-index: 20; display: flex; align-items: center; gap: 12px;
  font-size: 1.3rem; border: 2px solid #fff; box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
}
progress { -webkit-appearance: none; appearance: none; width: 150px; height: 20px; }
progress::-webkit-progress-bar { background-color: #444; border-radius: 10px; }
progress::-webkit-progress-value { background-color: #00ff00; border-radius: 10px; }

.message-window {
  flex: 1; border: 4px solid var(--border-color); border-radius: 8px;
  background: linear-gradient(to bottom, var(--pce-blue-top), var(--pce-blue-bottom));
  padding: 2.8rem 1.5rem 1.5rem 1.5rem; position: relative;
  font-size: clamp(1rem, 4vw, 1.5rem); line-height: 1.5;
  text-shadow: 2px 2px 0 #000; cursor: pointer; overflow: hidden;
}
.speaker-name {
  position: absolute; top: -2px; left: 1rem;
  background-color: var(--border-color); color: #000;
  padding: 4px 12px; border-radius: 0 0 8px 8px; font-weight: bold; font-size: 1rem;
}
.message-text { display: block; width: 100%; height: 100%; overflow-y: auto; }
.cursor-icon { position: absolute; bottom: 10px; right: 10px; animation: blink 1s infinite; }
.hidden { display: none !important; }

/* --- ã‚³ãƒãƒ³ãƒ‰ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆ4æŠã‚¢ã‚¤ã‚³ãƒ³ä»˜ãï¼‰ä¿®æ­£ç‰ˆ --- */
.command-window {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 40, 0.95); border: 4px solid #ffd700; 
  padding: 10px;
  /* iOS Safe Area å¯¾å¿œ */
  padding-bottom: max(10px, env(safe-area-inset-bottom));
  
  display: flex; flex-direction: column; z-index: 50; 
  align-items: center; justify-content: flex-start; /* ä¸Šè©°ã‚ã«ã—ã¦ä¸‹éƒ¨æº¢ã‚Œã‚’é˜²ã */
}

/* ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ† */
.command-title {
    color: #fff; margin-bottom: 8px; font-size: 1.2rem; flex-shrink: 0;
}

.command-grid {
  display: grid; width: 100%; 
  /* é«˜ã•100%ã§ã¯ãªãã€flex: 1 ã§æ®‹ã‚Šé ˜åŸŸã‚’åŸ‹ã‚ã‚‹è¨­å®šã«å¤‰æ›´ */
  flex: 1; min-height: 0; 
  gap: 8px;
  grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;
}
.spell-button {
  background: linear-gradient(to bottom, #555, #333);
  border: 2px solid #fff; border-radius: 12px;
  color: #fff; font-family: 'DotGothic16', monospace;
  cursor: pointer; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 4px; transition: transform 0.1s; box-shadow: 0 4px 0 #000;
  min-height: 0; /* Flexã‚¢ã‚¤ãƒ†ãƒ ã®ç¸®å°ã‚’è¨±å¯ */
  overflow: hidden; /* å¿µã®ãŸã‚ã®ã¯ã¿å‡ºã—é˜²æ­¢ */
}
.spell-button:active { transform: translateY(4px); box-shadow: 0 0 0 #000; background: #666; }
.spell-icon { font-size: 2.5rem; margin-bottom: 2px; text-shadow: 0 0 10px rgba(255,255,255,0.5); flex-shrink: 0; }
.spell-name { font-size: 1.2rem; font-weight: bold; color: #ffff00; flex-shrink: 0; }
.spell-desc { font-size: 0.7rem; color: #ddd; text-align: center; line-height: 1.1; overflow: hidden; }

/* ãƒ¢ãƒã‚¤ãƒ«å‘ã‘å¾®èª¿æ•´ï¼ˆç”»é¢ãŒç‹­ã„å ´åˆï¼‰ */
@media (max-height: 600px), (max-width: 400px) {
    .command-title { font-size: 1rem; margin-bottom: 5px; }
    .spell-icon { font-size: 2rem; }
    .spell-name { font-size: 1rem; }
    .spell-desc { font-size: 0.6rem; }
}

/* --- ãƒ•ã‚©ãƒˆã‚«ãƒ¼ãƒ‰ï¼ˆã‚¯ãƒªã‚¢æ¼”å‡ºï¼‰ --- */
.photo-card-overlay {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7); z-index: 200;
  display: flex; justify-content: center; align-items: center;
  backdrop-filter: blur(5px); animation: fadeIn 0.5s;
}
.photo-card {
  background: var(--card-bg); padding: 15px 15px 40px 15px;
  border-radius: 4px; box-shadow: 0 10px 20px var(--card-shadow);
  transform: rotate(-3deg) scale(0.9);
  transition: transform 0.3s;
  text-align: center; width: 80%; max-width: 350px;
}
.photo-card:hover { transform: rotate(0deg) scale(1.0); }
.photo-image-area {
  width: 100%; aspect-ratio: 1/1; background: #000;
  margin-bottom: 15px; border: 1px solid #ddd;
  display: flex; justify-content: center; align-items: center;
  overflow: hidden; position: relative;
}
.photo-image-area img { width: 120%; height: auto; }
.photo-caption {
  font-family: 'DotGothic16', monospace; color: #333;
  font-size: 1.2rem; font-weight: bold; transform: rotate(-1deg);
}
.photo-stamp {
  position: absolute; bottom: 10px; right: 10px;
  border: 3px solid #ff4444; color: #ff4444;
  font-weight: bold; padding: 5px 10px; transform: rotate(-15deg);
  font-size: 1.5rem; opacity: 0; animation: stampIn 0.5s 0.5s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.next-btn {
  margin-top: 20px; background: #4488ff; color: #fff; border: none;
  padding: 10px 20px; font-family: inherit; font-size: 1rem;
  border-radius: 20px; cursor: pointer; box-shadow: 0 4px 0 #0055cc;
}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes stampIn { from { transform: scale(3) rotate(-15deg); opacity: 0; } to { transform: scale(1) rotate(-15deg); opacity: 1; } }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
@keyframes shake { 0% { transform: translateX(-50%); } 25% { transform: translateX(-55%) rotate(-2deg); } 75% { transform: translateX(-45%) rotate(2deg); } 100% { transform: translateX(-50%); } }
.shake-anim { animation: shake 0.5s infinite; }
@keyframes magic-effect { 0% { transform: scale(0); opacity: 0; } 50% { opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
.magic-circle {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  width: 200px; height: 200px; border: 10px solid #fff; border-radius: 50%;
  box-shadow: 0 0 20px #fff; pointer-events: none; z-index: 1000;
  animation: magic-effect 0.8s ease-out forwards;
}
    </style>
</head>
<body>
    <div class="scanlines"></div>
    
    <div class="game-container">
        <div class="visual-area" id="visualArea">
            <img src="haikei.png" alt="" class="bg-image" id="bgImage">
            
            <div class="cat-room-layer" id="catRoomLayer"></div>

            <div class="title-screen" id="titleScreen">
                <div class="title-logo">ç•°ä¸–ç•Œãƒ‹ãƒ£ãƒ³é‚„<br><span style="font-size:1rem">ã€œé­”ç‹ã‚’å€’ã—ãŸå‹‡è€…ã®å®¶é›»ä¿®ç†è¨˜ã€œ</span></div>
                <button class="start-btn" id="startBtn">èª¿æŸ»é–‹å§‹</button>
            </div>
            
            <div class="actors-layer">
                <img src="images/character.png" alt="" class="actor hero hidden" id="heroActor">
                <img src="" alt="" class="actor npc hidden" id="npcActor">
                <img src="" alt="" class="actor item hidden" id="itemActor">
            </div>
            
            <div id="effectContainer"></div>
            
            <div class="status-bar hidden" id="statusBar">
                <span>ä¿®ç†é€²æ—:</span>
                <progress id="progressBar" value="0" max="100"></progress>
                <span id="progressPercent">0%</span>
            </div>
        </div>

        <div class="ui-area">
            <div class="message-window" id="msgWindow">
                <div class="speaker-name" id="speakerName">ã‚·ã‚¹ãƒ†ãƒ </div>
                <div class="message-text" id="messageText">å¾…æ©Ÿä¸­...</div>
                <div class="cursor-icon">â–¼</div>
            </div>

            <div class="command-window hidden" id="commandWindow">
                <div class="command-title">é­”æ³•ã‚’é¸ã‚“ã§ä¿®ç†ã›ã‚ˆï¼</div>
                <div class="command-grid" id="commandGrid"></div>
            </div>
        </div>
    </div>

    <div class="photo-card-overlay hidden" id="photoCardOverlay">
        <div class="photo-card">
            <div class="photo-image-area">
                <img src="" id="photoCardImg" alt="Result">
                <div class="photo-stamp">MISSION<br>COMPLETE!</div>
            </div>
            <div class="photo-caption" id="photoCardText">æ´—æ¿¯æ©Ÿã€å¾©æ´»ï¼</div>
            <button class="next-btn" id="photoNextBtn">æ¬¡ã¸é€²ã‚€ â¡</button>
        </div>
    </div>

    <script>
/**
 * ğŸ® ç•°ä¸–ç•Œãƒ‹ãƒ£ãƒ³é‚„ ã€œé­”ç‹ã‚’å€’ã—ãŸå‹‡è€…ã®å®¶é›»ä¿®ç†è¨˜ã€œ
 * iOS/Mobile Responsive Fix
 */

// ==========================================
// 1. ãƒ‡ãƒ¼ã‚¿å®šç¾©ï¼ˆã‚¢ã‚¤ã‚³ãƒ³è¿½åŠ ï¼‰
// ==========================================
const spells = [
    { name: "ã„ã¬ã—ãš", icon: "ğŸ¶", desc: "å ãˆã‚‹çŠ¬(ç£)ã‚’é™ã‚ã‚‹", id: "inushizu" },
    { name: "ã†ãã¨ã‚", icon: "âš“", desc: "æµ®ããƒ»æ­ªã¿ã‚’ç›´ã™", id: "ukitome" },
    { name: "ã²ã‹ã‚Šã¨", icon: "â˜€ï¸", desc: "å…‰ã‚„ç†±ã‚’èª¿ç¯€ã™ã‚‹", id: "hikarito" },
    { name: "ã­ã‚€ãŸã‚Œ", icon: "ğŸ’¤", desc: "ç›¸æ‰‹ã‚’çœ ã‚‰ã›ã‚‹", id: "nemutare" },
    { name: "ã‹ãœãã‚‹", icon: "ğŸŒ€", desc: "å¼·ã„é¢¨ã‚„ç©ºæ°—åœ§ã‚’æ‰±ã†", id: "kazekiru" },
    { name: "ã‚‰ã„ãªãŠ", icon: "âš¡", desc: "é›·(é›»æ°—)ã§ä¿®ç†ã™ã‚‹", id: "rainao" },
    { name: "ã¿ãšã ã—", icon: "ğŸ’§", desc: "æ°´ã‚’å‡ºã™ãƒ»æ´—ã†", id: "mizudashi" },
    { name: "ã‘ã‚€ã¯ã‚Œ", icon: "ğŸŒ«ï¸", desc: "ç…™ãƒ»éœ§ãƒ»è‡­ã„ã‚’æ¶ˆã™", id: "kemuhare" },
    { name: "ã‚ˆãªãã¾", icon: "ğŸ”‡", desc: "é¨’éŸ³ã‚’é™ã‹ã«ã™ã‚‹", id: "yonakima" },
    { name: "ãµã‚“ã‚ã‚Š", icon: "â˜ï¸", desc: "ç¡¬ã„ç‰©ã‚’æŸ”ã‚‰ã‹ãã™ã‚‹", id: "funwari" },
    { name: "ã‚‚ã©ã±ã‚“", icon: "â†©ï¸", desc: "æ•£ã‚‰ã°ã£ãŸç‰©ã‚’æˆ»ã™", id: "modopan" },
    { name: "ã²ã‚ãŸã‚‹", icon: "ğŸ”", desc: "å¤±ãã—ãŸç‰©ã‚’æ¢ã™", id: "hirotaru" },
    { name: "ã ã¾ãã", icon: "ğŸ›‘", desc: "å‹æ‰‹ã«å‹•ãç‰©ã‚’æ­¢ã‚ã‚‹", id: "damakiki" },
    { name: "ã¿ã¿ã§ã‚‹", icon: "ğŸ¥Š", desc: "è©°ã¾ã£ãŸç‰©ã‚’æŠ¼ã—å‡ºã™", id: "mimideru" },
    { name: "ãªã‹ãªãŠ", icon: "â¤ï¸", desc: "ã‚±ãƒ³ã‚«ã‚’ä»²ç›´ã‚Šã•ã›ã‚‹", id: "nakanao" }
];

let areaData = [
    { id: 1, name: 'çŒ«ã®åºƒå ´', npcImg: 'images/neko_transparent_7.png', itemImg: 'images/household_item_8.png', intro: "ã€Œå¤§å¤‰ã ãƒ‹ãƒ£ï¼ ã“ã®ã€å››è§’ã„ç®±ã€ãŒæ³¡ã‚’å¹ã„ã¦æš´ã‚Œã¦ã‚‹ãƒ‹ãƒ£ï¼ã€", problem: "æ´—æ¿¯æ©ŸãŒæ¿€ã—ãæŒ¯å‹•ã—ã¦ã€ã¾ã‚‹ã§æš´ã‚Œã‚‹ç£ã®ã‚ˆã†ã ã€‚", hint: "æš´ã‚Œã‚‹ç£ï¼ˆãƒ¢ãƒ¼ã‚¿ãƒ¼ï¼‰ã‚’é™ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚", correctSpell: "inushizu", successMsg: "é­”æ³•ã§ãƒ¢ãƒ¼ã‚¿ãƒ¼éŸ³ãŒé™ã¾ã‚Šã€æ­£å¸¸ã«å‹•ãå‡ºã—ãŸï¼", failMsg: "æ´—æ¿¯æ©Ÿã¯ã•ã‚‰ã«æ¿€ã—ãæš´ã‚Œå‡ºã—ãŸï¼" },
    { id: 2, name: 'é•·è€ã®å®¶', npcImg: 'images/neko_transparent_8.png', itemImg: 'images/household_item_3.png', intro: "ã€Œãƒ¯ã‚·ã®å®ç‰©ãŒã€ã“ã®ã€æœ¨ã®åŒ–ã‘ç‰©ã€ã«é£Ÿã‚ã‚ŒãŸã‚“ã˜ã‚ƒï¼ã€", problem: "ã‚¿ãƒ³ã‚¹ã®å¼•ãå‡ºã—ãŒå›ºãã¦é–‹ã‹ãªã„ã€‚", hint: "æ­ªã‚“ã å»ºã¦ä»˜ã‘ã‚’ã€åœ°é¢ã«æˆ»ã™ã‚ˆã†ã«ç›´ã›ã°â€¦ï¼Ÿ", correctSpell: "ukitome", successMsg: "ã‚«ã‚¿ãƒ³ï¼ã¨éŸ³ãŒã—ã¦ã€å¼•ãå‡ºã—ãŒã‚¹ãƒ ãƒ¼ã‚ºã«é–‹ã„ãŸï¼", failMsg: "ã‚¿ãƒ³ã‚¹ã¯ãƒ“ã‚¯ã¨ã‚‚ã—ãªã„â€¦" },
    { id: 3, name: 'å…±åŒæµ´å ´', npcImg: 'images/neko_transparent_6.png', itemImg: 'images/household_item_9.png', intro: "ã€Œã“ã®æ°´ãŸã¾ã‚Šã€ç†±ã™ãã¦å…¥ã‚Œãªã„ãƒ‹ãƒ£ã€œï¼ã€", problem: "ãŠé¢¨å‘‚ã®ãŠæ¹¯ãŒã‚°ãƒ©ã‚°ãƒ©ã¨æ²¸é¨°ã—ã¦ã„ã‚‹ã€‚", hint: "å¼·ã™ãã‚‹ã€ç†±ã€ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’æŠ‘ãˆã‚‹é­”æ³•ãªã‚‰â€¦ã€‚", correctSpell: "hikarito", successMsg: "ãŠæ¹¯ã®æ¸©åº¦ãŒä¸‹ãŒã‚Šã€æ¥µæ¥½ã®ã‚ˆã†ãªé©æ¸©ã«ãªã£ãŸï¼", failMsg: "ãŠæ¹¯ãŒã•ã‚‰ã«ç†±ããªã£ã¦ã—ã¾ã£ãŸï¼" },
    { id: 4, name: 'å®¿å±‹', npcImg: 'images/neko3.png', itemImg: 'images/household_item_5.png', intro: "ã€Œã“ã®ã€ãƒ•ã‚«ãƒ•ã‚«ã®å°ã€ã«ä¹—ã‚‹ã¨çœ ã£ã¡ã‚ƒã†å‘ªã„ãŒã‚ã‚‹ãƒ‹ãƒ£ï¼ã€", problem: "ãŸã ã®å¿«é©ã™ãã‚‹ãƒ™ãƒƒãƒ‰ã®ã‚ˆã†ã ã€‚çŒ«ãŸã¡ãŒæŠ—ãˆãšã«ã„ã‚‹ã€‚", hint: "ã„ã£ãã€å¿ƒåœ°ã‚ˆãçœ ã‚‰ã›ã¦ã‚ã’ã‚‹ã®ãŒå„ªã—ã•ã‹ã‚‚ï¼Ÿ", correctSpell: "nemutare", successMsg: "çŒ«ãŸã¡ã¯å¹¸ã›ãã†ãªé¡”ã§ã‚¹ãƒ¤ã‚¹ãƒ¤ã¨çœ ã‚Šã«ã¤ã„ãŸâ€¦ã€‚", failMsg: "çŒ«ãŸã¡ã¯ç„¡ç†ã‚„ã‚Šç›®ã‚’è¦šã¾ã•ã‚Œã€ä¸æ©Ÿå«Œãã†ã ã€‚" },
    { id: 5, name: 'è·¯åœ°è£', npcImg: 'images/neko_transparent_5.png', itemImg: 'images/household_item_1.png', intro: "ã€Œã“ã®ã€éŠ€è‰²ã®ç­’ã€ã‹ã‚‰ã€ã™ã”ã„æ‚ªè‡­ãŒã™ã‚‹ãƒ‹ãƒ£â€¦ã€", problem: "ã‚´ãƒŸç®±ã‹ã‚‰ç”Ÿã‚´ãƒŸã®è‡­ã„ãŒæ¼‚ã£ã¦ã„ã‚‹ã€‚", hint: "è‡­ã„ã‚„ç…™ã‚’æ¶ˆã™é­”æ³•ã‚’ä½¿ãŠã†ã€‚", correctSpell: "kemuhare", successMsg: "æ‚ªè‡­ãŒæ¶ˆãˆå»ã‚Šã€çˆ½ã‚„ã‹ãªç©ºæ°—ã«ãªã£ãŸï¼", failMsg: "è‡­ã„ãŒä½™è¨ˆã«åºƒãŒã£ã¦ã—ã¾ã£ãŸï¼" },
    { id: 6, name: 'æ°‘å®¶', npcImg: 'images/neko_transparent_4.png', itemImg: 'images/household_item_4.png', intro: "ã€ŒãŠæ°—ã«å…¥ã‚Šã®ã€ç‰¹ç­‰å¸­ã€ãŒãƒ™ã‚¿ãƒ™ã‚¿ã™ã‚‹ãƒ‹ãƒ£â€¦ã€", problem: "ã‚½ãƒ•ã‚¡ã«ä½•ã‹ã®ã‚¸ãƒ¥ãƒ¼ã‚¹ãŒã“ã¼ã‚Œã¦æ±šã‚Œã¦ã„ã‚‹ã€‚", hint: "æ°´ã§æ´—ã„æµã›ã°ãã‚Œã„ã«ãªã‚‹ã¯ãšã€‚", correctSpell: "mizudashi", successMsg: "æ¸…ã‚‰ã‹ãªæ°´ãŒæ±šã‚Œã‚’æ´—ã„æµã—ã€ãƒ”ã‚«ãƒ”ã‚«ã«ãªã£ãŸï¼", failMsg: "ã‚½ãƒ•ã‚¡ãŒæ°´æµ¸ã—ã«ãªã£ã¦ã—ã¾ã£ãŸâ€¦" },
    { id: 7, name: 'å›³æ›¸é¤¨', npcImg: 'images/neko_resized_3.png', itemImg: 'images/household_item_7.png', intro: "ã€Œæœ¬ãŒå‹æ‰‹ã«é£›ã³å‡ºã—ã¦ãã‚‹ãƒ‹ãƒ£ï¼ ãŠåŒ–ã‘ãƒ‹ãƒ£ï¼ã€", problem: "æœ¬æ£šã‹ã‚‰æœ¬ãŒãƒ‘ãƒ©ãƒ‘ãƒ©ã¨è½ã¡ã¦ãã‚‹ã€‚", hint: "å‹æ‰‹ã«å‹•ãç‰©ã‚’é™ã‚ã‚‹é­”æ³•ãŒå¿…è¦ã ã€‚", correctSpell: "damakiki", successMsg: "æœ¬ãŸã¡ã¯å¤§äººã—ããªã‚Šã€å…ƒã®ä½ç½®ã«åã¾ã£ãŸã€‚", failMsg: "æœ¬ãŒã•ã‚‰ã«å‹¢ã„ã‚ˆãé£›ã³å‡ºã—ã¦ããŸï¼" },
    { id: 8, name: 'å°æ‰€', npcImg: 'images/neko_transparent_4.png', itemImg: 'images/household_item_6.png', intro: "ã€Œæ°´ãŒæµã‚Œãªãã¦ã€æº¢ã‚Œãã†ã ãƒ‹ãƒ£ï¼ã€", problem: "æ’æ°´å£ãŒè©°ã¾ã£ã¦ã„ã‚‹ã‚ˆã†ã ã€‚", hint: "è©°ã¾ã£ã¦ã„ã‚‹ç‰©ã‚’ã€æŠ¼ã—å‡ºã™ã€é­”æ³•ã‚’ä½¿ãŠã†ã€‚", correctSpell: "mimideru", successMsg: "ãƒãƒ³ãƒƒï¼ã¨ã„ã†éŸ³ã¨å…±ã«è©°ã¾ã‚ŠãŒè§£æ¶ˆã•ã‚ŒãŸï¼", failMsg: "æ°´ãŒé€†æµã—ã¦æº¢ã‚Œå‡ºã—ãŸï¼" },
    { id: 9, name: 'é›†ä¼šæ‰€', npcImg: 'images/neko5.png', itemImg: 'images/household_item_2.png', intro: "ã€Œã“ã®ã€å¹³ã‚‰ãªå°ã€ã®è¶³ãŒæŠ˜ã‚Œã¦ã‚°ãƒ©ã‚°ãƒ©ã™ã‚‹ãƒ‹ãƒ£ã€‚ã€", problem: "ãƒ†ãƒ¼ãƒ–ãƒ«ã®è„šãŒä¸€æœ¬æŠ˜ã‚Œã‹ã‘ã¦ã„ã‚‹ã€‚", hint: "å£Šã‚ŒãŸç‰©ã‚’ç›´ã™ã«ã¯ã€é›·ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼ˆæº¶æ¥ï¼‰ã‚’ä½¿ã†ã€‚", correctSpell: "rainao", successMsg: "ç¨²å¦»ãŒèµ°ã‚Šã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®è„šãŒç¬æ™‚ã«ä¿®å¾©ã•ã‚ŒãŸï¼", failMsg: "ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç„¦ã’ã¦ã—ã¾ã£ãŸâ€¦" },
    { id: 10, name: 'å¤œã®åºƒå ´', npcImg: 'images/neko_resized_2.png', itemImg: 'images/household_item_8.png', intro: "ã€Œå¤œä¸­ãªã®ã«ã€ã“ã®ç®±ãŒãƒ–ãƒ¼ãƒ³ã£ã¦ã†ã‚‹ã•ã„ãƒ‹ãƒ£â€¦ã€", problem: "æ´—æ¿¯æ©Ÿã®è„±æ°´éŸ³ãŒã†ã‚‹ã•ãã¦çœ ã‚Œãªã„ã€‚", hint: "å¤œã®é¨’éŸ³ã‚’æ­¢ã‚ã‚‹å°‚ç”¨ã®é­”æ³•ãŒã‚ã‚‹ã€‚", correctSpell: "yonakima", successMsg: "éŸ³ãŒå¸ã„è¾¼ã¾ã‚Œã‚‹ã‚ˆã†ã«æ¶ˆãˆã€é™å¯‚ãŒè¨ªã‚ŒãŸã€‚", failMsg: "éŸ³ãŒã•ã‚‰ã«å¤§ãããªã‚Šã€è¿‘æ‰€è¿·æƒ‘ã«ï¼" },
    { id: 11, name: 'ç‰©ç½®', npcImg: 'images/neko_transparent_7.png', itemImg: 'images/household_item_3.png', intro: "ã€Œä¸­èº«ãŒãã¡ã‚ƒãã¡ã‚ƒã§ã€ä½•ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„ãƒ‹ãƒ£â€¦ã€", problem: "ã‚¿ãƒ³ã‚¹ã®ä¸­ãŒæ•£ã‚‰ã‹ã£ã¦ã„ã‚‹ã€‚", hint: "æ•£ã‚‰ã°ã£ãŸç‰©ã‚’ã€å…ƒã«æˆ»ã™ã€é­”æ³•ã‚’ä½¿ãŠã†ã€‚", correctSpell: "modopan", successMsg: "æœãŒã²ã¨ã‚Šã§ã«ç•³ã¾ã‚Œã€ãã‚Œã„ã«æ•´é “ã•ã‚ŒãŸï¼", failMsg: "ä¸­èº«ãŒã•ã‚‰ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚Œã¦ã—ã¾ã£ãŸâ€¦" },
    { id: 12, name: 'å†¬ã®é¢¨å‘‚å ´', npcImg: 'images/neko_transparent_7.png', itemImg: 'images/household_item_9.png', intro: "ã€Œæ°´ãŒå†·ãŸãã¦å‡ã£ã¡ã‚ƒã†ãƒ‹ãƒ£â€¦ã€", problem: "ãŠé¢¨å‘‚ã®æ°´ãŒæ°·ã®ã‚ˆã†ã«å†·ãŸã„ã€‚", hint: "é›·ã®ç†±ï¼ˆã‚¸ãƒ¥ãƒ¼ãƒ«ç†±ï¼‰ã§æ¸©ã‚ã‚ˆã†ã€‚", correctSpell: "rainao", successMsg: "ãƒ“ãƒªãƒ“ãƒªã¨é›»æµãŒèµ°ã‚Šã€ã‚ã£ã¨ã„ã†é–“ã«ãŠæ¹¯ãŒæ²¸ã„ãŸï¼", failMsg: "æ„Ÿé›»ã—ã¦çŒ«ã®æ¯›ãŒé€†ç«‹ã£ã¦ã—ã¾ã£ãŸï¼" },
    { id: 13, name: 'å­ä¾›éƒ¨å±‹', npcImg: 'images/neko_jump_surprised_transparent_48.png', itemImg: 'images/household_item_5.png', intro: "ã€Œãƒ™ãƒƒãƒ‰ãŒç¡¬ãã¦èƒŒä¸­ãŒç—›ã„ãƒ‹ãƒ£ï¼ã€", problem: "ãƒãƒƒãƒˆãƒ¬ã‚¹ãŒç…é¤…ã®ã‚ˆã†ã«ç¡¬ã„ã€‚", hint: "ãµã‚“ã‚ã‚Šã¨æŸ”ã‚‰ã‹ãã™ã‚‹é­”æ³•ã‚’ã€‚", correctSpell: "funwari", successMsg: "ãƒ™ãƒƒãƒ‰ãŒé›²ã®ã‚ˆã†ã«ãƒ•ã‚«ãƒ•ã‚«ã«ãªã£ãŸï¼", failMsg: "ãƒ™ãƒƒãƒ‰ãŒè±†è…ã®ã‚ˆã†ã«å´©ã‚Œã¦ã—ã¾ã£ãŸâ€¦" },
    { id: 14, name: 'ã‚´ãƒŸæ¨ã¦å ´', npcImg: 'images/neko_transparent_8.png', itemImg: 'images/household_item_1.png', intro: "ã€Œã‚´ãƒŸç®±ã®ãƒ•ã‚¿ãŒé–‹ã‹ãªã„ãƒ‹ãƒ£ï¼ æ¨ã¦ã‚‰ã‚Œãªã„ãƒ‹ãƒ£ï¼ã€", problem: "ã‚´ãƒŸç®±ã®ãƒ•ã‚¿ãŒéŒ†ã³ä»˜ã„ã¦å›ºã¾ã£ã¦ã„ã‚‹ã€‚", hint: "æµ®ãã‚’æ­¢ã‚ã‚‹ï¼ˆå›ºç€ã‚’å¤–ã™ï¼‰é­”æ³•ã‚’è©¦ã—ã¦ã¿ã‚ˆã†ã€‚", correctSpell: "ukitome", successMsg: "ãƒ•ã‚¿ãŒãƒ‘ã‚«ãƒƒã¨è»½ã‚„ã‹ã«é–‹ã„ãŸï¼", failMsg: "ãƒ•ã‚¿ãŒå®Œå…¨ã«æº¶æ¥ã•ã‚Œã¦ã—ã¾ã£ãŸâ€¦" },
    { id: 15, name: 'ãƒªãƒ“ãƒ³ã‚°', npcImg: 'images/neko_transparent_8.png', itemImg: 'images/household_item_4.png', intro: "ã€Œã“ã®æ¤…å­ã€åº§ã‚‹ã¨æ²ˆã¿ã™ãã¦å‡ºã‚‰ã‚Œãªã„ãƒ‹ãƒ£ï¼ã€", problem: "ã‚½ãƒ•ã‚¡ãŒæŸ”ã‚‰ã‹ã™ãã¦ã€çŒ«ãŒåŸ‹ã¾ã£ã¦ã„ã‚‹ã€‚", hint: "é¢¨ã®åŠ›ï¼ˆç©ºæ°—åœ§ï¼‰ã‚’å…¥ã‚Œã¦å¼µã‚Šã‚’æˆ»ãã†ã€‚", correctSpell: "kazekiru", successMsg: "ã‚½ãƒ•ã‚¡ã«ç©ºæ°—ãŒæˆ»ã‚Šã€ã¡ã‚‡ã†ã©ã„ã„å¼¾åŠ›ã«ãªã£ãŸï¼", failMsg: "ã‚½ãƒ•ã‚¡ãŒç ´è£‚ã—ã¦ç¶¿ãŒé£›ã³å‡ºã—ãŸï¼" },
    { id: 16, name: 'æ´—ã„å ´', npcImg: 'images/neko_transparent_7.png', itemImg: 'images/household_item_6.png', intro: "ã€Œå¤§åˆ‡ãªæŒ‡è¼ªã‚’æµã—ã¡ã‚ƒã£ãŸãƒ‹ãƒ£â€¦ã€", problem: "æ’æ°´å£ã®å¥¥ã«ã‚­ãƒ©ãƒªã¨å…‰ã‚‹ã‚‚ã®ãŒè¦‹ãˆã‚‹ã€‚", hint: "å¤±ãã—ãŸç‰©ã‚’æ¢ã—ã¦æ‰‹å…ƒã«å‘¼ã¶é­”æ³•ã€‚", correctSpell: "hirotaru", successMsg: "æŒ‡è¼ªãŒå…‰ã«åŒ…ã¾ã‚Œã¦æµ®ãä¸ŠãŒã£ã¦ããŸï¼", failMsg: "æŒ‡è¼ªã¯ã•ã‚‰ã«å¥¥æ·±ãã¸æµã‚Œã¦ã„ã£ãŸâ€¦" },
    { id: 17, name: 'æ›¸æ–', npcImg: 'images/neko_resized_1.png', itemImg: 'images/household_item_7.png', intro: "ã€Œæš—ãã¦å­—ãŒèª­ã‚ãªã„ãƒ‹ãƒ£ã€‚ã€", problem: "éƒ¨å±‹ãŒè–„æš—ãã€æœ¬æ£šã®æœ¬ãŒè¦‹ãˆã«ãã„ã€‚", hint: "å…‰ã‚’ç¯ã™é­”æ³•ã‚’ä½¿ãŠã†ã€‚", correctSpell: "hikarito", successMsg: "å„ªã—ã„å…‰ãŒç¯ã‚Šã€æ–‡å­—ãŒã¯ã£ãã‚Šèª­ã‚ã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚", failMsg: "çœ©ã—ã™ãã¦ç›®ãŒé–‹ã‘ã‚‰ã‚Œãªã„ï¼" },
    { id: 18, name: 'é£Ÿå ‚', npcImg: 'images/neko_transparent_5.png', itemImg: 'images/household_item_2.png', intro: "ã€Œãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸Šã§ã‚³ãƒƒãƒ—ã¨ãŠçš¿ãŒã‚±ãƒ³ã‚«ã—ã¦ã‚‹ãƒ‹ãƒ£ï¼ã€", problem: "é£Ÿå™¨ãŸã¡ãŒã‚«ãƒãƒ£ã‚«ãƒãƒ£ã¨ã¶ã¤ã‹ã‚Šåˆã£ã¦ã„ã‚‹ã€‚", hint: "ã‚±ãƒ³ã‚«ã‚’ä»²ç›´ã‚Šã•ã›ã‚‹é­”æ³•ãŒã‚ã‚‹ã¯ãšã€‚", correctSpell: "nakanao", successMsg: "é£Ÿå™¨ãŸã¡ã¯é™ã‹ã«ãªã‚Šã€ãã‚Œã„ã«ä¸¦ã‚“ã ã€‚", failMsg: "é£Ÿå™¨ãŸã¡ãŒæ´¾æ‰‹ã«å‰²ã‚Œã¦ã—ã¾ã£ãŸï¼" },
    { id: 19, name: 'å®¶é›»ç½®ãå ´', npcImg: 'images/neko_transparent_6.png', itemImg: 'images/household_item_8.png', intro: "ã€Œå‹•ã‹ãªã„ãƒ‹ãƒ£ã€‚ãŸã ã®ç®±ã«ãªã£ã¡ã‚ƒã£ãŸãƒ‹ãƒ£ã€‚ã€", problem: "æ´—æ¿¯æ©Ÿã®é›»æºãŒå…¥ã‚‰ãªã„ã‚ˆã†ã ã€‚", hint: "é›»æ°—è£½å“ã‚’ç›´ã™ãªã‚‰ã€é›·ã®é­”æ³•ã€‚", correctSpell: "rainao", successMsg: "é€šé›»ã—ã€LEDãƒ‘ãƒãƒ«ãŒæ˜ã‚‹ãç‚¹ç¯ã—ãŸï¼", failMsg: "é»’ç„¦ã’ã«ãªã£ã¦ç…™ãŒå‡ºã¦ããŸâ€¦" },
    { id: 20, name: 'çŒ«ã®ç‹å®®', npcImg: 'images/neko1.png', itemImg: 'images/image.png', intro: "ã€Œæœ€å¾Œã«â€¦ç§ãŸã¡ã¨ä»²è‰¯ãã—ã¦ãã‚Œã‚‹ã‹ãƒ‹ãƒ£ï¼Ÿã€", problem: "çŒ«ãŸã¡ãŒä¸å®‰ãã†ã«ã“ã¡ã‚‰ã‚’è¦‹ã¦ã„ã‚‹ã€‚", hint: "ç¨®æ—ã‚’è¶…ãˆã¦ä»²è‰¯ããªã‚‹é­”æ³•ã€‚", correctSpell: "nakanao", successMsg: "å‹‡è€…ã¨çŒ«ãŸã¡ã®é–“ã«æ¸©ã‹ã„çµ†ãŒç”Ÿã¾ã‚ŒãŸï¼", failMsg: "çŒ«ãŸã¡ã¯è­¦æˆ’ã—ã¦é€ƒã’ã¦ã—ã¾ã£ãŸâ€¦" }
];

const audioAssets = {
    talk: ['audio/nyan.mp3', 'audio/nyan2.mp3', 'audio/nyan3.mp3'],
    success: 'audio/nyan6.mp3', 
    fail: 'audio/nyan8.mp3',   
    surprise: 'audio/nyan4.mp3',
    sad: 'audio/nyan7.mp3',
    ending: 'audio/nyan9.mp3',
    bgm: 'audio/Pixel Wandererâ€™s Lullaby.mp3' 
};

// ==========================================
// 2. ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
// ==========================================
let currentState = 'title';
let currentArea = null;
let textAnimInterval = null;
let clearedCount = 0;
let currentDisplayText = '';
let bgmAudio = null;
let isAudioUnlocked = false;

const els = {
    bg: document.getElementById('bgImage'),
    hero: document.getElementById('heroActor'),
    npc: document.getElementById('npcActor'),
    item: document.getElementById('itemActor'),
    msgText: document.getElementById('messageText'),
    speaker: document.getElementById('speakerName'),
    cmdWindow: document.getElementById('commandWindow'),
    cmdGrid: document.getElementById('commandGrid'),
    progress: document.getElementById('progressBar'),
    percent: document.getElementById('progressPercent'),
    statusBar: document.getElementById('statusBar'),
    titleScreen: document.getElementById('titleScreen'),
    catRoomLayer: document.getElementById('catRoomLayer'),
    startBtn: document.getElementById('startBtn'),
    effectContainer: document.getElementById('effectContainer'),
    photoOverlay: document.getElementById('photoCardOverlay'),
    photoImg: document.getElementById('photoCardImg'),
    photoText: document.getElementById('photoCardText'),
    photoNextBtn: document.getElementById('photoNextBtn')
};

// ==========================================
// 3. åˆæœŸåŒ– & ãƒ«ãƒ¼ãƒ—
// ==========================================
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

document.addEventListener('DOMContentLoaded', () => {
    els.startBtn.addEventListener('click', onStartGame);
    els.photoNextBtn.addEventListener('click', onPhotoClose);

    const clickZone = document.querySelector('.ui-area');
    const handler = (e) => {
        if(e && e.cancelable) e.preventDefault();
        handleUserClick();
    };
    clickZone.addEventListener('click', handler);
    clickZone.addEventListener('touchend', handler);

    const normalEvents = areaData.filter(a => a.id !== 20);
    const lastEvent = areaData.find(a => a.id === 20);
    shuffleArray(normalEvents);
    areaData = [...normalEvents, lastEvent];
    areaData.forEach(a => a.cleared = false);
    
    updateCatRoom();
});

function handleUserClick() {
    if (!isAudioUnlocked) unlockAudio();
    if (currentState === 'title' || currentState === 'photo_wait' || currentState === 'command_wait') return;

    switch (currentState) {
        case 'opening': nextOpeningScene(); break;
        case 'map': startNextEvent(); break;
        case 'event_talk': showCommandWindow(); break;
        case 'repair_success_wait': showPhotoCard(); break;
        case 'ending': nextEndingScene(); break;
    }
}

function unlockAudio() {
    if(isAudioUnlocked) return;
    if (!bgmAudio) {
        bgmAudio = new Audio(audioAssets.bgm);
        bgmAudio.loop = true;
        bgmAudio.volume = 0.3;
        bgmAudio.load();
    }
    const silent = new Audio();
    silent.play().catch(()=>{});
    isAudioUnlocked = true;
}

function updateCatRoom() {
    els.catRoomLayer.innerHTML = '';
    const clearedAreas = areaData.filter(a => a.cleared);
    
    let displayCats = [...clearedAreas];
    if(displayCats.length < 3) {
        const others = areaData.filter(a => !a.cleared).slice(0, 3 - displayCats.length);
        displayCats = displayCats.concat(others);
    }

    displayCats.forEach((area, i) => {
        const cat = document.createElement('img');
        cat.src = area.cleared ? 'images/neko6.png' : area.npcImg;
        cat.className = 'room-cat';
        const left = 10 + Math.random() * 80; 
        const top = 30 + Math.random() * 50;
        cat.style.left = left + '%';
        cat.style.top = top + '%';
        cat.style.animationDelay = (i * 0.5) + 's';
        els.catRoomLayer.appendChild(cat);
    });
}

function onStartGame() {
    if(!isAudioUnlocked) unlockAudio();
    if(bgmAudio) bgmAudio.play().catch(e=>{});

    els.titleScreen.classList.add('hidden');
    els.statusBar.classList.remove('hidden');
    
    if (clearedCount === 0) {
        startOpening();
    } else {
        currentState = 'map';
        showMessage("ã‚·ã‚¹ãƒ†ãƒ ", "èª¿æŸ»ã‚’å†é–‹ã—ã¾ã™ã€‚");
    }
}

// ==========================================
// 4. ã‚²ãƒ¼ãƒ é€²è¡Œ
// ==========================================
const openingScenes = [
    { bg: 'haikei.png', hero: true, npc: false, speaker: 'ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', text: "é­”ç‹ã‚’å€’ã—ãŸå‹‡è€…ã€‚ã—ã‹ã—ã€å‡±æ—‹ã®é€”ä¸­ã§è¬ã®ç©´ã«è½ã¡ã¦ã—ã¾ã£ãŸâ€¦â€¦ã€‚", sound: null },
    { bg: 'haikei.png', hero: true, npc: 'images/neko_jump_surprised_transparent_48.png', speaker: 'ï¼Ÿï¼Ÿï¼Ÿ', text: "ã€Œãƒ‹ãƒ£ãƒ‹ãƒ£ãƒƒï¼ï¼Ÿï¼ˆã ã€èª°ã ãƒ‹ãƒ£ï¼ï¼Ÿï¼‰ã€", sound: 'surprise' },
    { bg: 'haikei.png', hero: true, npc: 'images/neko1.png', speaker: 'å‹‡è€…', text: "ã“ã“ã¯â€¦â€¦çŒ«ã®å›½ï¼Ÿ è¦‹ãŸã“ã¨ã®ãªã„é«˜åº¦ãªé“å…·ï¼ˆå®¶é›»ï¼‰ãŒæ•£ã‚‰ã°ã£ã¦ã„ã‚‹ã€‚", sound: null },
    { bg: 'haikei.png', hero: true, npc: 'images/neko_transparent_7.png', speaker: 'æ‘é•·çŒ«', text: "ã€ŒãŠé¡˜ã„ã ãƒ‹ãƒ£ï¼ æ‘ã®ã‚ã¡ã“ã¡ã§ã€ä¼èª¬ã®éºç‰©ã€ãŒæš´èµ°ã—ã¦ã‚‹ã®ãƒ‹ãƒ£ï¼ å…¨éƒ¨ç›´ã—ã¦ãƒ‹ãƒ£ï¼ã€", sound: 'talk' }
];
let openingIndex = -1;

function startOpening() {
    currentState = 'opening';
    openingIndex = -1;
    els.catRoomLayer.innerHTML = '';
    nextOpeningScene();
}

function nextOpeningScene() {
    openingIndex++;
    if (openingIndex >= openingScenes.length) {
        currentState = 'map';
        showMessage("ã‚·ã‚¹ãƒ†ãƒ ", "ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€èª¿æŸ»ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚");
        return;
    }
    const scene = openingScenes[openingIndex];
    els.bg.src = scene.bg;
    els.hero.classList.toggle('hidden', !scene.hero);
    if (scene.npc) { els.npc.src = scene.npc; els.npc.classList.remove('hidden'); } 
    else { els.npc.classList.add('hidden'); }
    els.item.classList.add('hidden');
    showMessage(scene.speaker, scene.text, scene.sound);
}

function startNextEvent() {
    const targetArea = areaData.find(a => !a.cleared);
    if (!targetArea) { startEnding(); return; }
    currentArea = targetArea;
    currentState = 'event_talk';
    
    els.bg.src = 'haikei.png';
    els.hero.classList.remove('hidden');
    els.hero.src = 'images/character.png'; 
    els.npc.src = currentArea.npcImg;
    els.npc.classList.remove('hidden');
    els.item.src = currentArea.itemImg;
    els.item.classList.remove('hidden');
    els.item.classList.add('shake-anim');
    
    showMessage(currentArea.name, currentArea.intro, 'talk');
}

function showCommandWindow() {
    currentState = 'command_wait';
    els.cmdWindow.classList.remove('hidden');
    els.msgText.classList.add('text-hidden');
    els.speaker.textContent = 'å‹‡è€…ã®æ€è€ƒ';
    els.cmdGrid.innerHTML = '';

    const correctSpell = spells.find(s => s.id === currentArea.correctSpell);
    const otherSpells = spells.filter(s => s.id !== currentArea.correctSpell);
    shuffleArray(otherSpells);
    const wrongSpells = otherSpells.slice(0, 3);
    const choices = [correctSpell, ...wrongSpells];
    shuffleArray(choices);

    choices.forEach(spell => {
        const btn = document.createElement('div');
        btn.className = 'spell-button';
        btn.innerHTML = `<div class="spell-icon">${spell.icon}</div><div class="spell-name">${spell.name}</div><div class="spell-desc">${spell.desc}</div>`;
        
        const triggerSpell = (e) => {
            e.stopPropagation(); e.preventDefault();
            castSpell(spell.id);
        };
        btn.addEventListener('click', triggerSpell);
        btn.addEventListener('touchend', triggerSpell);
        els.cmdGrid.appendChild(btn);
    });
}

function castSpell(spellId) {
    els.cmdWindow.classList.add('hidden');
    
    const magicDiv = document.createElement('div');
    magicDiv.className = 'magic-circle';
    els.effectContainer.appendChild(magicDiv);
    playAudio('talk'); 

    setTimeout(() => {
        magicDiv.remove();
        if (spellId === currentArea.correctSpell) {
            playAudio('success'); 
            els.item.classList.remove('shake-anim'); 
            showRepairResult(); 
        } else {
            playAudio('fail');
            showMessage("å¤±æ•—...", currentArea.failMsg);
            currentState = 'event_talk';
        }
    }, 800);
}

function showRepairResult() {
    currentState = 'repair_success_wait';
    els.msgText.classList.remove('text-hidden');
    showMessage("ä¿®ç†å®Œäº†ï¼", currentArea.successMsg);
}

function showPhotoCard() {
    currentState = 'photo_wait';
    els.photoImg.src = currentArea.itemImg; 
    els.photoText.textContent = `File.${currentArea.id} ä¿®ç†å®Œäº†ï¼`;
    els.photoOverlay.classList.remove('hidden');
}

function onPhotoClose() {
    els.photoOverlay.classList.add('hidden');
    
    currentArea.cleared = true;
    clearedCount++;
    updateProgress();
    
    currentState = 'map';
    els.npc.src = 'images/neko6.png'; 
}

// ==========================================
// ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ»å…±é€šé–¢æ•°
// ==========================================
const endingScenes = [
    { text: "20å€‹ã™ã¹ã¦ã®å®¶é›»ãƒˆãƒ©ãƒ–ãƒ«ã‚’è§£æ±ºã—ãŸï¼", sound: 'success' },
    { npc: 'images/neko6.png', speaker: 'çŒ«ãŸã¡', text: "ã€Œã™ã”ã„ãƒ‹ãƒ£ï¼ å‹‡è€…æ§˜ã¯ä¼èª¬ã®ä¿®ç†å±‹ã•ã‚“ã ãƒ‹ãƒ£ï¼ã€", sound: 'talk' },
    { npc: 'images/neko_transparent_7.png', speaker: 'å‹‡è€…', text: "ï¼ˆâ€¦â€¦ä¿®ç†å±‹ã‚‚æ‚ªããªã„ãªã€‚ã§ã‚‚ã€ãã‚ãã‚å¸°ã‚‰ã­ã°ã€‚ï¼‰", sound: 'sad' },
    { bg: 'black', hero: false, npc: false, item: false, text: "å‹‡è€…ã¯çŒ«ãŸã¡ã«è¦‹é€ã‚‰ã‚Œã€å…‰ã®ä¸­ã¸æ¶ˆãˆã¦ã„ã£ãŸã€‚", sound: null },
    { bg: 'haikei.png', speaker: 'ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°', text: "å…ƒã®ä¸–ç•Œã«æˆ»ã£ãŸå‹‡è€…ã®æ‰‹ã«ã¯ã€ãŠåœŸç”£ã®ã€çŒ«ã˜ã‚ƒã‚‰ã—ã€ãŒæ¡ã‚‰ã‚Œã¦ã„ãŸã€‚", sound: 'ending' },
    { text: "THE END - Thank you for playing!", sound: null }
];
let endingIndex = -1;

function startEnding() {
    currentState = 'ending';
    endingIndex = -1;
    els.item.classList.add('hidden');
    if(bgmAudio) bgmAudio.pause();
    nextEndingScene();
}

function nextEndingScene() {
    endingIndex++;
    if (endingIndex >= endingScenes.length) return;
    const scene = endingScenes[endingIndex];
    if (scene.bg === 'black') { els.bg.style.display = 'none'; els.hero.classList.add('hidden'); els.npc.classList.add('hidden'); } 
    else if (scene.bg) { els.bg.style.display = 'block'; els.bg.src = scene.bg; }
    if (scene.npc) { els.npc.src = scene.npc; els.npc.classList.remove('hidden'); }
    showMessage(scene.speaker || '', scene.text, scene.sound);
}

function showMessage(name, text, soundType = null) {
    if (textAnimInterval) { clearInterval(textAnimInterval); textAnimInterval = null; }
    els.msgText.textContent = '';
    currentDisplayText = '';
    els.speaker.textContent = name;
    els.msgText.classList.remove('text-hidden');
    if (soundType) playAudio(soundType);
    const targetText = text;
    let charIndex = 0;
    textAnimInterval = setInterval(() => {
        charIndex++;
        currentDisplayText = targetText.substring(0, charIndex);
        els.msgText.textContent = currentDisplayText;
        els.msgText.scrollTop = els.msgText.scrollHeight;
        if (soundType === 'talk' && Math.random() > 0.8) playRandomTalkSound();
        if (charIndex >= targetText.length) { clearInterval(textAnimInterval); textAnimInterval = null; }
    }, 40);
}

function playAudio(type) {
    if (type === 'talk') playRandomTalkSound();
    else if (audioAssets[type]) {
        const audio = new Audio(audioAssets[type]);
        audio.volume = 0.5;
        audio.play().catch(e => {});
    }
}
function playRandomTalkSound() {
    const srcs = audioAssets.talk;
    const src = srcs[Math.floor(Math.random() * srcs.length)];
    const audio = new Audio(src);
    audio.volume = 0.3;
    audio.playbackRate = 0.8 + Math.random() * 0.4; 
    audio.play().catch(e => {});
}
function updateProgress() {
    const total = areaData.length;
    const percent = Math.round((clearedCount / total) * 100);
    els.progress.value = percent;
    els.percent.textContent = percent + '%';
}
    </script>
</body>
</html>
